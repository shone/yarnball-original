<!doctype html>
<html>

  <head>

    <meta charset="utf-8">
    
    <title>Yarnball</title>
    
    <link rel="icon" href="/favicon.png">
    
    <meta name="viewport" content="width=device-width, user-scalable=no">
    
    <link rel="stylesheet" href="/bower_components/normalize-css/normalize.css">
    
    <link rel="stylesheet" href="/style.css">
    <link href='https://fonts.googleapis.com/css?family=Lora' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'>
    
    <script src="/bower_components/requirejs/require.js"></script>
    <script>
      require.config({
        baseUrl: '/',
        paths: {
          core: '/core',
        },
      });
    </script>
    
    <script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    
    <link rel="import" href="/bower_components/iron-pages/iron-pages.html">
    
    <link rel="import" href="/landing-page/landing-page.html">
    <link rel="import" href="/scratchpad/scratchpad.html">
    <link rel="import" href="/login/login.html">
    <link rel="import" href="/signup/signup.html">
    <link rel="import" href="/user/user.html">
    
    <link rel="import" href="/widgets/socketio/socketio-status.html">
    
  </head>

  <body unresolved>
  
    <span id="browser-sync-binding"></span>
    
    <iron-pages id="main-pages">
      <yb-landing-page></yb-landing-page>
      <yb-scratchpad></yb-scratchpad>
      <yb-login></yb-login>
      <yb-signup></yb-signup>
    </iron-pages>
    
    <script>
      document.addEventListener('WebComponentsReady', function() {
      
        require(['bower_components/page/page', 'socket.io-client/socket.io'], function(page, SocketIO) {
        
          var mainPages = document.getElementById('main-pages');
          
          page('/', function(context) {
            mainPages.select(0);
          });
          page('/scratchpad', function(context) {
            mainPages.select(1);
          });
          page('/login', function(context) {
            mainPages.select(2);
          });
          page('/signup', function(context) {
            mainPages.select(3);
          });
          page('/user', function(context) {
            mainPages.select(4);
          });
          page('*', function(context) {
          
            function splitPath(path) {
              return path.split('/').filter(function(element) {
                return element !== '';
              });
            }
            
            var pathElements = splitPath(context.path);
            if (pathElements.length > 0) {
              var pathBase = pathElements[0];
              
              var socketioUsers = SocketIO();
              socketioUsers.on('connect', function() {
                socketioUsers.emit('hasUser', pathBase);
                socketioUsers.on('hasUser_result', function(username, hasUser) {
                  if (username === pathBase && hasUser) {
                    var userPage = document.createElement('yb-user');
                    userPage.set('username', username);
                    Polymer.dom(mainPages).appendChild(userPage);
                    mainPages.select(4);
                  }
                });
              });
            }
          });
          
          page();
        });
      });
    </script>
  </body>
  
</html>
