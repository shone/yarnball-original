<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-button/paper-button.html">

<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icons/social-icons.html">

<link rel="import" href="/widgets/socketio/web-socketio.html">
<link rel="import" href="/widgets/web-status/web-status.html">

<link rel="import" href="user-styles.html">

<dom-module id="yb-user">

  <style include="user-styles"></style>

  <template>
    <paper-button id="logoutButton" on-tap="logout">Log out</paper-button>
    
    <div id="pageError">
      <iron-icon icon="icons:lock"></iron-icon>
      <span id="pageErrorMessage"></span>
    </div>
    
    <div id="user">
      <iron-icon id="userIcon" icon="social:person"></iron-icon>
      <span id="username">{{username}}</span>
    </div>
    
    <yb-web-status id="webStatus"></yb-web-status>
    
    <div id="surfaceList">
      
    </div>
  </template>
  
  <script>
    (function() {
      Polymer({
        is: 'yb-user',
        behaviors: [Web_SocketIO_Behavior],
        properties: {
          username: {
            type: String,
          }
        },
        setUserSession: function(userSession) {
          this.userSession = userSession;
          this.set('username', userSession.username);
        },
        ready: function() {
          this.onInit(function(web) {
            require(['user-web'], function(UserWeb) {
//               var userWeb = UserWeb(web
            });
          });
        },
        attached: function() {
          var self = this;
          
          if (!self.userSession) {
            self.classList.add('page-error');
            self.$.pageErrorMessage.textContent = 'Cannot open user page, no user session.';
            return;
          }
          
          console.log('User page for "' + self.userSession.username + '" attempting to connect..');
          
          require(['socket.io-client/socket.io', 'core/node'], function(SocketIO, Node) {
            
            // TODO: If already connected, send authenticate message instead of specifying forceNew
            var socketio = SocketIO('/' + self.userSession.usernode, {forceNew: true, query: self.userSession ? ("token=" + self.userSession.token) : null});
            
            socketio.on('connect', function() {
              console.log('User page for "' + self.userSession.username + '" connected to user namespace.');
              self.setSocketio(socketio);
            });
            
            socketio.on('error', function(error) {
              console.error(error);
              self.classList.add('page-error');
              var errorMessage = error;
              if (typeof error === 'object' && 'message' in error) {
                errorMessage = error.message;
              }
              self.$.pageErrorMessage.textContent = errorMessage;
            });
          });
        },
        logout: function() {
          window.localStorage.removeItem('userSession');
          // TODO: Disconnect socket
          require(['bower_components/page/page'], function(page) {
            page('/login');
          });
        },
      });
    })();
  </script>

</dom-module>