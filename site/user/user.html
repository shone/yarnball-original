<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/widgets/socketio/web-socketio.html">
<link rel="import" href="/widgets/web-status/web-status.html">
<link rel="import" href="/widgets/surface/surface.html">

<link rel="import" href="user-styles.html">

<dom-module id="yb-user">

  <style include="user-styles"></style>

  <template>
    USER
    <yb-web-socketio id="web_socketio">
      <yb-web-status></yb-web-status>
      <yb-surface></yb-surface>
    </yb-web-socketio>
  </template>
  
  <script>
    (function() {
      Polymer({
        is: 'yb-user',
        properties: {
          username: {
            type: String,
          },
        },
        attached: function() {
          var self = this;
          self.web_socketio = self.$.web_socketio;
          require(['socket.io-client/socket.io'], function(SocketIO) {
            console.log('User page for "' + self.username + '" attempting to connect..');
            var authToken = window.localStorage.authToken;
            if (!authToken) {
              console.error('User page cannot connect to user namespace, no auth token found.');
              return;
            }
            
            // TODO: If already connected, send authenticate message instead of specifying forceNew
            var socketio = SocketIO('/' + self.username, {forceNew: true, query: "token=" + authToken});
            
            socketio.on('connect', function() {
              console.log('User page for "' + self.username + '" connected to user namespace.');
              self.web_socketio.setSocketio(socketio);
            });
            
            socketio.on('error', function(error) {
              console.error(error);
            });
          });
        },
      });
    })();
  </script>

</dom-module>