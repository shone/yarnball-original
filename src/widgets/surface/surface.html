<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../node/node.html">
<link rel="import" href="../connector/connector.html">
<link rel="import" href="../set/set.html">

<link rel="import" href="surface-styles.html">

<dom-module id="yb-surface">

  <style include="surface-styles"></style>

  <template>
    <div id="background"></div>
    <iron-dropdown id="dropdown" horizontal-align="left" vertical-align="top">
      <div class="dropdown-content">
        <paper-menu>
          <paper-item on-tap="menuItem_CreateNode">Create Node</paper-item>
          <paper-item>Create Link</paper-item>
          <paper-item on-tap="menuItem_CreateSet">Create Set</paper-item>
        </paper-menu>
      </div>
    </iron-dropdown>
  </template>
  
  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'yb-surface',
        created: function() {
          var self = this;
          require(['client', 'node_id'], function(client, node_id) {
            self.client  = client;
            self.node_id = node_id;
          });
        },
        ready: function() {
        
          var self = this;
        
          require(['client', 'node_id'], function(client, node_id) {
            self.client  = client;
            self.node_id = node_id;
        
            self.oncontextmenu = function(event) {
              event.preventDefault();
              return false;
            }
            
            self.$.background.onmousedown = function(event) {
              self.backgroundMousedown(event);
            }
            
            self.nodeWidgets = [];
            
            self.connectors = [];
            self.connectorsFrom = new Map();
            self.connectorsVia  = new Map();
            self.connectorsTo   = new Map();
            
            self.createNodeWidget({x: 100, y: 100});
            self.createNodeWidget({x: 250, y: 180});
            self.createNodeWidget({x: 450, y: 150});
          });
        },
        backgroundMousedown: function(event) {
          if (event.button === 2) {
            event.preventDefault();
            this.lastMenuPosition = {
              x: event.offsetX,
              y: event.offsetY,
            }
            this.$.dropdown.set('horizontalOffset', event.offsetX);
            this.$.dropdown.set('verticalOffset',   event.offsetY);
            if (!this.$.dropdown.opened) {
              this.$.dropdown.open();
            }
            return false;
          }
        },
        createNodeWidget: function(position) {
        
          var self = this;
        
          var nodeWidget = document.createElement('yb-node');
          nodeWidget['node-id'] = self.node_id.makeHex();
          nodeWidget.style.position = 'absolute';
          nodeWidget.style.left = position.x + 'px';
          nodeWidget.style.top  = position.y + 'px';
          nodeWidget.position = position;
          
          nodeWidget.addEventListener('dimensionsChanged', function(event) {
            self.updateConnectorsForNodeWidget(nodeWidget);
          });
          
          self._setupNodeWidgetDragging(nodeWidget);
          self._setupNodeWidgetConnectorDragging(nodeWidget);
          
          Polymer.dom(self.root).appendChild(nodeWidget);
          
          self.nodeWidgets.push(nodeWidget);
          
          return nodeWidget;
        },
        _setupNodeWidgetDragging: function(nodeWidget) {
        
          var self = this;
        
          nodeWidget.addEventListener('dragStart', function(event) {
            var nodeOffset = event.detail;
            var surfaceRect = self.getBoundingClientRect();
            function handleMousemove(event) {
            
              var newPos = {
                x: (event.pageX - surfaceRect.left) - nodeOffset.x,
                y: (event.pageY - surfaceRect.top)  - nodeOffset.y,
              }
            
              nodeWidget.style.left = newPos.x + 'px';
              nodeWidget.style.top  = newPos.y + 'px';
              nodeWidget.position = newPos;
              
              self.updateConnectorsForNodeWidget(nodeWidget);
            }
            function handleMouseup() {
              window.removeEventListener('mousemove', handleMousemove);
              window.removeEventListener('mouseup',   handleMouseup);
            }
            window.addEventListener('mousemove', handleMousemove);
            window.addEventListener('mouseup',   handleMouseup);
          });
        },
        _setupNodeWidgetConnectorDragging: function(nodeWidget) {
        
          var self = this;
        
          nodeWidget.addEventListener('rightButtonDragStart', function(event) {
          
            var surfaceRect = self.getBoundingClientRect();
          
            if (!self.draggingConnector) {
              self.draggingConnector = document.createElement('yb-connector');
              Polymer.dom(self.root).appendChild(self.draggingConnector);
            }
            self.draggingConnector.set('fromPos', nodeWidget.centerPosition());
            
            self.draggingConnectorNodes = {
              from: nodeWidget,
              via:  null,
              to:   null,
            }
            
            function handleOtherNodeMouseover(event) {
              var otherNodeWidget = event.currentTarget;
              if (!self.draggingConnectorNodes.from) {
                self.draggingConnectorNodes.from = otherNodeWidget;
                self.draggingConnector.set('fromPos', otherNodeWidget.centerPosition());
              } else if (!self.draggingConnectorNodes.via) {
                if (otherNodeWidget !== self.draggingConnectorNodes.from) {
                  self.draggingConnectorNodes.via = otherNodeWidget;
                  self.draggingConnector.set('viaPos', otherNodeWidget.centerPosition());
                }
              } else if (!self.draggingConnectorNodes.to) {
                if (otherNodeWidget !== self.draggingConnectorNodes.via) {
                  self.draggingConnectorNodes.to = otherNodeWidget;
                  self.draggingConnector.set('toPos', otherNodeWidget.centerPosition());
                }
              }
            }
            
            self.nodeWidgets.forEach(function(otherNodeWidget) {
              if (otherNodeWidget !== nodeWidget) {
                otherNodeWidget.addEventListener('mouseover', handleOtherNodeMouseover);
              }
            });
            
            function handleMousemove(event) {
            
              var cursorPos = {
                x: event.pageX - surfaceRect.left,
                y: event.pageY - surfaceRect.top,
              }
              
              if (!self.draggingConnectorNodes.via) {
                self.draggingConnector.set('viaPos', cursorPos);
              } else if(!self.draggingConnectorNodes.to) {
                self.draggingConnector.set('toPos', cursorPos);
              }
            }
            function handleMouseup(event) {
              window.removeEventListener('mousemove', handleMousemove);
              window.removeEventListener('mouseup',   handleMouseup);
              
              self.nodeWidgets.forEach(function(otherNodeWidget) {
                if (otherNodeWidget !== nodeWidget) {
                  otherNodeWidget.removeEventListener('mouseover', handleOtherNodeMouseover);
                }
              });
              
              if (self.draggingConnectorNodes.from &&
                  self.draggingConnectorNodes.via &&
                  self.draggingConnectorNodes.to) {
                self.createConnector(self.draggingConnectorNodes.from,
                                     self.draggingConnectorNodes.via,
                                     self.draggingConnectorNodes.to);
              }
              
              Polymer.dom(self.root).removeChild(self.draggingConnector);
              self.draggingConnector = null;
            }
            
            window.addEventListener('mousemove', handleMousemove);
            window.addEventListener('mouseup',   handleMouseup);
          });
        },
        createConnector: function(fromWidget, viaWidget, toWidget) {
          var connector = document.createElement('yb-connector');
          Polymer.dom(this.root).appendChild(connector);
          
          this.connectors.push(connector);
          
          if (!this.connectorsFrom.has(fromWidget)) {
            this.connectorsFrom.set(fromWidget, [connector]);
          } else {
            this.connectorsFrom.get(fromWidget).push(connector);
          }
          
          if (!this.connectorsVia.has(viaWidget)) {
            this.connectorsVia.set(viaWidget, [connector]);
          } else {
            this.connectorsVia.get(viaWidget).push(connector);
          }
          
          if (!this.connectorsTo.has(toWidget)) {
            this.connectorsTo.set(toWidget, [connector]);
          } else {
            this.connectorsTo.get(toWidget).push(connector);
          }
          
          connector.set('fromPos', fromWidget.centerPosition());
          connector.set('viaPos',  viaWidget.centerPosition());
          connector.set('toPos',   toWidget.centerPosition());
          
          return connector;
        },
        updateConnectorsForNodeWidget: function(nodeWidget) {
          if (this.connectorsFrom.has(nodeWidget)) {
            var connectorsFrom = this.connectorsFrom.get(nodeWidget);
            connectorsFrom.forEach(function(connector) {
              connector.set('fromPos', nodeWidget.centerPosition());
            });
          }
          if (this.connectorsVia.has(nodeWidget)) {
            var connectorsVia = this.connectorsVia.get(nodeWidget);
            connectorsVia.forEach(function(connector) {
              connector.set('viaPos', nodeWidget.centerPosition());
            });
          }
          if (this.connectorsTo.has(nodeWidget)) {
            var connectorsTo = this.connectorsTo.get(nodeWidget);
            connectorsTo.forEach(function(connector) {
              connector.set('toPos', nodeWidget.centerPosition());
            })
          }
        },
        menuItem_CreateNode: function() {
          this.$.dropdown.close();
          this.createNodeWidget(this.lastMenuPosition);
        },
        menuItem_CreateSet: function() {
          var self = this;
          
          self.$.dropdown.close();
          
          var setWidget = document.createElement('yb-set');
          setWidget.via = '52f9cf0e223d559931856acc98400f21';
          setWidget.to  = '5c4d67cf88fd9c5dbc841dee378b6b4b';
          setWidget.style.position = 'absolute';
          setWidget.style.left = self.lastMenuPosition.x + 'px';
          setWidget.style.top  = self.lastMenuPosition.y + 'px';
          setWidget.style.width  = "300px";
          setWidget.style.height = "200px";
          
          Polymer.dom(self.root).appendChild(setWidget);
        }
      });
    })();
  </script>

</dom-module>