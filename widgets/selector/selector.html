<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../dragdrop-area/dragdrop-area.html">

<link rel="import" href="selector-styles.html">

<dom-module id="yb-selector">

  <style include="selector-styles"></style>

  <template>
    <yb-dragdrop-area id="dropTarget" on-nodes-dropped="nodesDropped">
      <button id="clearButton">
        <iron-icon icon="icons:clear"></iron-icon>
      </button>
    </yb-dragdrop-area>
  </template>
  
  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'yb-selector',
        properties: {
          'nodeId': {
            type: String,
            observer: 'nodeIdChanged',
            notify: true,
          },
        },
        ready: function() {
          var self = this;
        
          self.classList.toggle('is-empty', self.nodeId ? false : true);
          
          self.dropTarget  = self.$.dropTarget;
          self.clearButton = self.$.clearButton;
          
          self.dropTarget.dropRequestHandler = function(widgets) {
            return Array.from(widgets).filter(function(widget) {
              return widget.widgetType === 'yb-node';
            });
          }
        
          if (self.nodeId) {
            var nodeWidget = document.createElement('yb-node');
            nodeWidget.nodeId = self.nodeId;
            self._setNodeWidget(nodeWidget);
          } else {
            self.nodeWidget = null;
          }
          
          self.clearButton.addEventListener('click', function(event) {
            self.set('nodeId', null);
          });
        },
        nodesDropped: function(event) {
          var nodeWidgets = Array.from(event.detail);
          if (nodeWidgets.length === 1) {
            var nodeWidget = nodeWidgets[0];
            nodeWidget.style.position = null;
            nodeWidget.style.left = 0;
            nodeWidget.style.top  = 0;
            this._setNodeWidget(nodeWidget);
            this.set('nodeId', nodeWidget.nodeId);
          }
        },
        nodeIdChanged: function() {
        
          this.classList.toggle('is-empty', this.nodeId ? false : true);
          
          if (this.nodeId) {
          
            if (!this.nodeWidget || this.nodeWidget.nodeId !== this.nodeId) {
              var nodeWidget = document.createElement('yb-node');
              nodeWidget.nodeId = this.nodeId;
              this._setNodeWidget(nodeWidget);
            }
          } else {
            if (this.nodeWidget) {
              this.dropTarget.removeChild(this.nodeWidget);
              this.nodeWidget = null;
            }
          }
          
          this.fire('nodeIdChanged', this.nodeId);
        },
        _setNodeWidget: function(nodeWidget) {
          if (this.nodeWidget) {
            this.dropTarget.removeChild(this.nodeWidget);
          }
          this.dropTarget.insertBefore(nodeWidget, this.dropTarget.firstChild);
          this.nodeWidget = nodeWidget;
        }
      });
    })();
  </script>

</dom-module>